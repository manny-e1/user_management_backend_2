# Admin Portal Backend

This README provides information about the Admin Portal, a backend project. It covers how to run the project in development and production modes, details about the packages used, and some key functionalities of the application

## Prerequisites

To run this project, it's recommended to have these installed on your computer.

- Node.js (v16.14.0 or higher)
  To install Node.js 18.\*, use the following command:

```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - &&\
sudo apt-get install -y nodejs
```

- npm (v8.0.0 or higher)

## Running the Application

First, you need to install all the dependencies that are listed in package.json file.

```bash
npm install
```

### Development Mode

To run the application in development mode, use the following command:

```bash
npm run dev
```

This command will start the application using tsx, which will automatically restart the application when file changes in the directory are detected.

### Production Mode

To run the application in production mode, use the following command:

```bash
npm start
```

The application will start listening on port 5001.

For running in an EC2 instance.

1. First get the **.pem** file and ip for the that instance:
2. Navigate to the folder where you put the **.pem** file and give it permission using your terminal

```bash
chmod 400 name.pem
```

3. SSH into the server

```bash
ssh -i name.pem ubuntu@123.45.67.89
```

4. Clone the project from github and do the necessary steps to install the dependecies
5. You can use **pm2**, a process manager for Node.js applications to run it

```bash
npm install pm2 -g
```

Then, you can start the application with **pm2**:

```bash
npm run pm2
```

## Packages Used

This project uses several packages. The following are some of the key packages and their roles:

- @tanstack/react-query: Used for fetching, caching, synchronizing and updating server state in the application.
- **pg**: A PostgreSQL client for Node.js, used for interacting with the PostgreSQL database.
- **dotenv**: Used to load environment variables from a **_.env_** file.
- **express**: A minimal and flexible Node.js web application framework that provides a robust set of features for web and mobile applications.
- **cors**: A package for providing a Connect/Express middleware that can be used to enable CORS.
- **zod**: A declarative JavaScript schema validation library.
- **drizzle-orm**: A simple, lightweight, and powerful ORM for SQL databases.
- **typescript**: Used for writing typed JavaScript at any scale.

## Database Setup

This application uses PostgreSQL as its database. The schema for the database is created using migration files generated by the **drizzle-kit** package. To create a new migration file, use the following command:

```bash
npm run migrate
```

When you start the application, the schema will be migrated to the specified database in the **_.env_** file.

## Environment Variables

The application uses several environment variables, which are loaded from a **_.env_** file using the **dotenv** package. Here is a brief description of each:

- **DB_USER**, **DB_PWD**, **DB_HOST**, **DB_NAME** (required): These are the credentials for the production database.
- **DB_USER_LOCAL**, **DB_PWD_LOCAL**, **DB_HOST_LOCAL**, **DB_PORT_LOCAL**, **DB_NAME_LOCAL**: These are the credentials for the local database.
- **EMAIL_FROM**, **EMAIL_HOST**, **EMAIL_PORT**, **EMAIL_USER**, **EMAIL_PASS** (required): These are used for sending emails.
- **EMAIL_FROM_LOCAL**, **EMAIL_HOST_LOCAL**, **EMAIL_PORT_LOCAL**, **EMAIL_USER_LOCAL**, **EMAIL_PASS_LOCAL**: These are used for sending emails for local development.
- **SECRET_KEY** (required): This is used for JWT token generation and validation.
- **NODE_ENV** (required): This should be set to **development** or **production** based on the environment.
- **PORT** (required): This is the port on which the application will run.
  Please note that the absence of any required field will result in the application crashing.

## Usage

Before starting to create user-groups make sure to manually create the 6 roles that are needed respectively.

1. admin
2. admin 2
3. manager 1
4. manager 2
5. normal User 1
6. normal User 2

Since there is no means of creating users and user-groups if there isn’t already a user with admin/admin 2 roles, you have to use the api endpoints to create a user-group with an admin role and a user with that user-group. You can use curl or postman to do this.

1. Creating a role

```bash
curl -X POST -d '{"role":"admin"}' -H "Content-Type:application/json" localhost:5001/api/roles
```

2. Creating a user-group

```bash
curl -X POST -d '{"name":"group_name", "roleId":1}' -H "Content-Type:application/json" localhost:5001/api/groups
```

3. Creating a user account

```bash
curl -X POST -d '{"name":"some_name","staffId":"staff_id", "userGroup":"id_of_user-group__you_just_created", "email":"your_email"}' -H "Content-Type:application/json" http://localhost:5001/api/users
```

4. Setting a password(if you didn’t get any email)

```bash
curl -X POST -d '{"password":"8_chars_with_at_least_one_uppercase_letter_one_lowercase_letter_one_number_and_one_special_character", "id":"your_user_id", "src":"activate"}' -H "Content-Type:application/json" http://localhost:5001/api/users/reset-password
```

After this you can head to [login](http://localhost:30001/login) page and use your credentials
